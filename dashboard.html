<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Trading</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <div class="nav-bar">
            <a href="dashboard.html">Trading</a>
            <a href="transferir.html">Transferir</a>
            <a href="perfil.html">Mi Perfil</a>
            <a href="admin.html" id="admin-link" style="display:none;">Admin</a>
            <a href="#" onclick="cerrarSesion()">Cerrar sesiÃ³n</a>
        </div>

        <h1>Panel de Trading</h1>
        <div class="flex-row">
            <div class="balance-box">
                <h3>Tu saldo</h3>
                <p>USDT: <span id="saldo-usdt">0.00</span></p>
                <p>BTC: <span id="saldo-btc">0.0000</span></p>
            </div>
            <div class="price-box">
                <h3>Precio BTC</h3>
                <p>$<span id="precio-btc">0.00</span></p>
                <p>Actualizado: <span id="timestamp-precio">---</span></p>
            </div>
        </div>

        <div class="chart-container">
            <canvas id="graficoBTC"></canvas>
        </div>

        <div class="card">
            <h3>Comprar / Vender BTC</h3>
            <div class="flex-row">
                <input type="number" id="cantidad" placeholder="Cantidad BTC" step="0.001" min="0">
                <button onclick="comprar()">Comprar BTC</button>
                <button onclick="vender()">Vender BTC</button>
            </div>
            <p id="mensaje-operacion"></p>
        </div>

        <div class="card">
            <h3>Staking (ingreso pasivo)</h3>
            <p>Bloquea USDT por 24h y gana hasta 5% diario (simulado)</p>
            <input type="number" id="staking-cantidad" placeholder="Cantidad USDT" step="1" min="0">
            <button onclick="iniciarStaking()">Iniciar Staking</button>
            <p id="staking-info"></p>
        </div>

        <div class="card">
            <h3>ðŸŽ² Minijuegos para ganar USDT</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px,1fr)); gap:15px;">
                <div>
                    <h4>Cara o cruz</h4>
                    <input type="number" id="apuesta-cc" placeholder="Apuesta USDT" step="1">
                    <select id="eleccion-cc">
                        <option value="cara">Cara</option>
                        <option value="cruz">Cruz</option>
                    </select>
                    <button onclick="jugar('caraocruz')">Jugar</button>
                </div>
                <div>
                    <h4>Dados (mayor que 3)</h4>
                    <input type="number" id="apuesta-dados" placeholder="Apuesta USDT" step="1">
                    <button onclick="jugar('dados')">Lanzar dados</button>
                </div>
                <div>
                    <h4>Ruleta (nÃºmero 0-36)</h4>
                    <input type="number" id="apuesta-ruleta" placeholder="Apuesta USDT" step="1">
                    <input type="number" id="numero-ruleta" placeholder="NÃºmero" min="0" max="36">
                    <button onclick="jugar('ruleta')">Girar</button>
                </div>
            </div>
            <p id="mensaje-juego"></p>
        </div>

        <div id="mensajes"></div>
    </div>

    <script>
        // âš ï¸ REEMPLAZA CON TUS DATOS
        const GITHUB_TOKEN = 'poner-tu-token-aqui';
        const REPO = 'robtegastudio/juego-trading';

        let usuario = localStorage.getItem('usuario');
        if (!usuario) window.location.href = 'index.html';

        let saldoUSDT = 1000;
        let saldoBTC = 0;
        let precioBTC = 50000;
        let historialPrecios = [];
        let chart;

        async function cargarDatos() {
            try {
                const response = await fetch('users.json?t=' + Date.now());
                if (response.ok) {
                    const users = await response.json();
                    if (users[usuario]) {
                        saldoUSDT = users[usuario].saldoUSDT || 1000;
                        saldoBTC = users[usuario].btc || 0;
                        
                        // Mostrar enlace admin si el rol es admin
                        if (users[usuario].rol === 'admin') {
                            document.getElementById('admin-link').style.display = 'inline-block';
                        }
                    }
                }
            } catch (e) {}
            actualizarInterfazSaldo();
            actualizarPrecio();
        }

        function actualizarInterfazSaldo() {
            document.getElementById('saldo-usdt').innerText = saldoUSDT.toFixed(2);
            document.getElementById('saldo-btc').innerText = saldoBTC.toFixed(4);
        }

        async function actualizarPrecio() {
            try {
                const response = await fetch('prices.json?t=' + Date.now());
                if (response.ok) {
                    const data = await response.json();
                    precioBTC = data.BTC.precio;
                    document.getElementById('precio-btc').innerText = precioBTC.toFixed(2);
                    const fecha = new Date(data.BTC.timestamp * 1000);
                    document.getElementById('timestamp-precio').innerText = fecha.toLocaleTimeString();

                    historialPrecios.push(precioBTC);
                    if (historialPrecios.length > 30) historialPrecios.shift();
                    if (chart) {
                        chart.data.labels = historialPrecios.map((_, i) => i);
                        chart.data.datasets[0].data = historialPrecios;
                        chart.update();
                    }
                }
            } catch (e) {}
        }

        function initChart() {
            const ctx = document.getElementById('graficoBTC').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Precio BTC (USDT)',
                        data: [],
                        borderColor: '#f0b90b',
                        backgroundColor: 'rgba(240, 185, 11, 0.1)',
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { grid: { color: '#2a3a5a' } } }
                }
            });
        }

        window.comprar = function() {
            let cantidad = parseFloat(document.getElementById('cantidad').value);
            if (isNaN(cantidad) || cantidad <= 0) {
                document.getElementById('mensaje-operacion').innerText = 'Cantidad invÃ¡lida';
                return;
            }
            let costo = cantidad * precioBTC;
            if (costo > saldoUSDT) {
                document.getElementById('mensaje-operacion').innerText = 'Saldo USDT insuficiente';
                return;
            }
            saldoUSDT -= costo;
            saldoBTC += cantidad;
            actualizarInterfazSaldo();
            document.getElementById('mensaje-operacion').innerText = `Comprados ${cantidad.toFixed(4)} BTC por ${costo.toFixed(2)} USDT`;
            guardarCambiosLocales();
        };

        window.vender = function() {
            let cantidad = parseFloat(document.getElementById('cantidad').value);
            if (isNaN(cantidad) || cantidad <= 0) {
                document.getElementById('mensaje-operacion').innerText = 'Cantidad invÃ¡lida';
                return;
            }
            if (cantidad > saldoBTC) {
                document.getElementById('mensaje-operacion').innerText = 'BTC insuficiente';
                return;
            }
            let ganancia = cantidad * precioBTC;
            saldoBTC -= cantidad;
            saldoUSDT += ganancia;
            actualizarInterfazSaldo();
            document.getElementById('mensaje-operacion').innerText = `Vendidos ${cantidad.toFixed(4)} BTC por ${ganancia.toFixed(2)} USDT`;
            guardarCambiosLocales();
        };

        function guardarCambiosLocales() {
            localStorage.setItem('saldoUSDT_' + usuario, saldoUSDT);
            localStorage.setItem('saldoBTC_' + usuario, saldoBTC);
        }

        window.iniciarStaking = function() {
            let cantidad = parseFloat(document.getElementById('staking-cantidad').value);
            if (isNaN(cantidad) || cantidad <= 0) {
                document.getElementById('staking-info').innerText = 'Cantidad invÃ¡lida';
                return;
            }
            if (cantidad > saldoUSDT) {
                document.getElementById('staking-info').innerText = 'Saldo insuficiente';
                return;
            }
            document.getElementById('staking-info').innerText = `Has bloqueado ${cantidad} USDT. Vuelve maÃ±ana para reclamar intereses (simulado).`;
        };

        window.jugar = async function(juego) {
            let apuesta, eleccion;
            if (juego === 'caraocruz') {
                apuesta = parseFloat(document.getElementById('apuesta-cc').value);
                eleccion = document.getElementById('eleccion-cc').value;
            } else if (juego === 'dados') {
                apuesta = parseFloat(document.getElementById('apuesta-dados').value);
            } else if (juego === 'ruleta') {
                apuesta = parseFloat(document.getElementById('apuesta-ruleta').value);
                eleccion = parseInt(document.getElementById('numero-ruleta').value);
            }

            if (!apuesta || apuesta <= 0) {
                document.getElementById('mensaje-juego').innerText = 'Apuesta invÃ¡lida';
                return;
            }
            if (apuesta > saldoUSDT) {
                document.getElementById('mensaje-juego').innerText = 'Saldo insuficiente';
                return;
            }

            // Simular resultado local
            let gana = false;
            if (juego === 'caraocruz') {
                const resultado = Math.random() < 0.5 ? 'cara' : 'cruz';
                gana = (resultado === eleccion);
            } else if (juego === 'dados') {
                const dado = Math.floor(Math.random() * 6) + 1;
                gana = dado > 3;
            } else if (juego === 'ruleta') {
                const numero = Math.floor(Math.random() * 37);
                gana = (numero === eleccion);
            }

            document.getElementById('mensaje-juego').innerText = gana ? 'ðŸŽ‰ Â¡Ganaste! (procesando...)' : 'ðŸ˜ž Perdiste (procesando...)';

            const titulo = `JUEGO:${usuario}:${juego}:${apuesta}:${gana ? 'gana' : 'pierde'}`;
            try {
                await fetch(`https://api.github.com/repos/${REPO}/issues`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ title: titulo, body: 'Resultado de juego' })
                });
            } catch (e) {
                console.error('Error registrando juego');
            }
        };

        window.cerrarSesion = function() {
            localStorage.removeItem('usuario');
            window.location.href = 'index.html';
        };

        window.onload = function() {
            initChart();
            cargarDatos();
            setInterval(actualizarPrecio, 10000);
        };
    </script>
</body>
</html>
